name: Integrated Tax Law Scraper

# éŒ¯èª¤é˜²è­·ï¼šæ˜ç¢ºå®šç¾©æ¬Šé™ï¼ˆé¿å… exit code 128ï¼‰
permissions:
  contents: write
  issues: write
  actions: read

on:
  schedule:
    # æ¯å¤©å°ç£æ™‚é–“ 18:00 åŸ·è¡Œ (UTC 10:00)
    - cron: '0 10 * * *'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  scrape_all:
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: æª¢å‡ºç¨‹å¼ç¢¼
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²è¨˜éŒ„
    
    # Step 2: è¨­å®š Python ç’°å¢ƒ
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    # Step 3: å®‰è£ç›¸ä¾å¥—ä»¶
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 pandas lxml
        echo "âœ… å¥—ä»¶å®‰è£å®Œæˆ"
    
    # Step 4: åŸ·è¡Œç¨…å‹™å‡½é‡‹çˆ¬èŸ²
    - name: Run Tax Ruling Scraper
      id: tax_scraper
      continue-on-error: true  # å³ä½¿å¤±æ•—ä¹Ÿç¹¼çºŒåŸ·è¡Œ
      run: |
        echo "ğŸ” é–‹å§‹çˆ¬å–ç¨…å‹™å‡½é‡‹..."
        python smart_scraper.py
        
        # è®€å–å ±å‘Š
        if [ -f "data/daily_report.json" ]; then
          HAS_NEW_TAX=$(python -c "import json; data=json.load(open('data/daily_report.json')); print(str(data.get('has_new', False)).lower())")
          NEW_TAX_COUNT=$(python -c "import json; data=json.load(open('data/daily_report.json')); print(data.get('new_count', 0))")
          echo "has_new_tax=$HAS_NEW_TAX" >> $GITHUB_OUTPUT
          echo "new_tax_count=$NEW_TAX_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… ç¨…å‹™å‡½é‡‹çˆ¬å–å®Œæˆï¼Œæ–°å¢ $NEW_TAX_COUNT ç­†"
        else
          echo "has_new_tax=false" >> $GITHUB_OUTPUT
          echo "new_tax_count=0" >> $GITHUB_OUTPUT
          echo "âš ï¸ ç¨…å‹™å‡½é‡‹çˆ¬å–ç„¡çµæœ"
        fi
    
    # Step 5: åŸ·è¡Œæ³•è¦è‰æ¡ˆçˆ¬èŸ²
    - name: Run Draft Law Scraper
      id: draft_scraper
      continue-on-error: true
      run: |
        echo "ğŸ” é–‹å§‹çˆ¬å–æ³•è¦è‰æ¡ˆ..."
        python draft_law_scraper.py
        
        # è®€å–å ±å‘Š
        if [ -f "data/draft_report.json" ]; then
          HAS_NEW_DRAFT=$(python -c "import json; data=json.load(open('data/draft_report.json')); print(str(data.get('has_new', False)).lower())")
          NEW_DRAFT_COUNT=$(python -c "import json; data=json.load(open('data/draft_report.json')); print(data.get('new_drafts', 0))")
          echo "has_new_draft=$HAS_NEW_DRAFT" >> $GITHUB_OUTPUT
          echo "new_draft_count=$NEW_DRAFT_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… æ³•è¦è‰æ¡ˆçˆ¬å–å®Œæˆï¼Œæ–°å¢ $NEW_DRAFT_COUNT ç­†"
        else
          echo "has_new_draft=false" >> $GITHUB_OUTPUT
          echo "new_draft_count=0" >> $GITHUB_OUTPUT
          echo "âš ï¸ æ³•è¦è‰æ¡ˆçˆ¬å–ç„¡çµæœ"
        fi
    
    # Step 6: å»ºç«‹æ•´åˆé€šçŸ¥ (åªåœ¨æœ‰æ–°è³‡æ–™æ™‚)
    - name: Create Integrated Notification
      if: steps.tax_scraper.outputs.has_new_tax == 'true' || steps.draft_scraper.outputs.has_new_draft == 'true'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const now = new Date().toLocaleString('zh-TW', {timeZone: 'Asia/Taipei'});
          
          let body = `# ğŸ“Š ç¨…å‹™æ³•è¦æ¯æ—¥æ›´æ–°å ±å‘Š\n\n`;
          body += `**åŸ·è¡Œæ™‚é–“**: ${now}\n\n`;
          
          // ç¨…å‹™å‡½é‡‹éƒ¨åˆ†
          const hasTax = '${{ steps.tax_scraper.outputs.has_new_tax }}' === 'true';
          const taxCount = '${{ steps.tax_scraper.outputs.new_tax_count }}';
          
          if (hasTax) {
            body += `## ğŸ›ï¸ ç¨…å‹™å‡½é‡‹æ›´æ–°\n\n`;
            body += `ç™¼ç¾ **${taxCount}** ç­†æ–°å‡½é‡‹\n\n`;
            
            try {
              const taxData = JSON.parse(fs.readFileSync('data/today_new.json', 'utf8'));
              taxData.slice(0, 5).forEach((item, i) => {
                body += `${i + 1}. **${item.title || 'ç„¡æ¨™é¡Œ'}**\n`;
                body += `   - æ—¥æœŸ: ${item.date || 'N/A'}\n`;
                body += `   - å­—è™Ÿ: ${item.doc_number || 'N/A'}\n`;
                if (item.url) {
                  body += `   - ğŸ”— [æŸ¥çœ‹åŸæ–‡](${item.url})\n`;
                }
                body += `\n`;
              });
              if (taxData.length > 5) {
                body += `...é‚„æœ‰ ${taxData.length - 5} ç­†æ›´å¤šå‡½é‡‹\n\n`;
              }
            } catch (e) {
              body += `è©³ç´°è³‡æ–™è¼‰å…¥å¤±æ•—\n\n`;
            }
          }
          
          // æ³•è¦è‰æ¡ˆéƒ¨åˆ†
          const hasDraft = '${{ steps.draft_scraper.outputs.has_new_draft }}' === 'true';
          const draftCount = '${{ steps.draft_scraper.outputs.new_draft_count }}';
          
          if (hasDraft) {
            body += `## ğŸ“œ æ³•è¦è‰æ¡ˆæ›´æ–°\n\n`;
            body += `ç™¼ç¾ **${draftCount}** ç­†æ–°è‰æ¡ˆ\n\n`;
            
            try {
              const draftFiles = fs.readdirSync('data').filter(f => f.startsWith('drafts_'));
              if (draftFiles.length > 0) {
                const latestDraft = draftFiles.sort().pop();
                const draftData = JSON.parse(fs.readFileSync(`data/${latestDraft}`, 'utf8'));
                
                draftData.slice(0, 5).forEach((item, i) => {
                  body += `${i + 1}. **${item.title || 'ç„¡æ¨™é¡Œ'}**\n`;
                  body += `   - å…¬å‘Šæ—¥æœŸ: ${item.announcement_date_roc || 'N/A'}\n`;
                  body += `   - æˆªæ­¢æ—¥æœŸ: ${item.end_date_roc || 'N/A'}\n`;
                  body += `   - ç‹€æ…‹: ${item.status || 'N/A'}\n`;
                  if (item.url) {
                    body += `   - ğŸ”— [æŸ¥çœ‹è©³æƒ…](${item.url})\n`;
                  }
                  body += `\n`;
                });
                
                if (draftData.length > 5) {
                  body += `...é‚„æœ‰ ${draftData.length - 5} ç­†æ›´å¤šè‰æ¡ˆ\n\n`;
                }
              }
            } catch (e) {
              body += `è©³ç´°è³‡æ–™è¼‰å…¥å¤±æ•—\n\n`;
            }
          }
          
          body += `---\n`;
          body += `*æ­¤å ±å‘Šç”±è‡ªå‹•åŒ–ç³»çµ±ç”¢ç”Ÿ*\n`;
          body += `*éŒ¯èª¤é˜²è­·æ©Ÿåˆ¶å·²å•Ÿç”¨ï¼Œç¢ºä¿è³‡æ–™æº–ç¢ºæ€§*`;
          
          // å»ºç«‹ Issue
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸ“Š ç¨…å‹™æ³•è¦æ›´æ–° - ${now.split(' ')[0]}`,
            body: body,
            labels: ['auto-update', 'tax-law']
          });
          
          console.log('âœ… é€šçŸ¥å·²å»ºç«‹');
    
    # Step 7: ä¸Šå‚³è³‡æ–™æª”æ¡ˆ
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: scraping-results-${{ github.run_number }}
        path: |
          data/*.json
          data/*.csv
        retention-days: 30
    
    # Step 8: æäº¤æ­·å²è¨˜éŒ„åˆ° repository
    - name: Commit history files
      if: always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # åªæäº¤æ­·å²æª”æ¡ˆï¼Œé¿å…é‡è¤‡æäº¤å¤§é‡è³‡æ–™
        git add data/*history.json data/*report.json 2>/dev/null || true
        
        if git diff --staged --quiet; then
          echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
        else
          git commit -m "Update scraping history - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… æ­·å²è¨˜éŒ„å·²æ›´æ–°"
        fi
    
    # Step 9: åŸ·è¡Œæ‘˜è¦
    - name: Show execution summary
      if: always()
      run: |
        echo "========================================"
        echo "ğŸ“Š åŸ·è¡Œæ‘˜è¦"
        echo "========================================"
        echo "ç¨…å‹™å‡½é‡‹ï¼š"
        echo "  - åŸ·è¡Œç‹€æ…‹: ${{ steps.tax_scraper.outcome }}"
        echo "  - æ–°å¢æ•¸é‡: ${{ steps.tax_scraper.outputs.new_tax_count }}"
        echo ""
        echo "æ³•è¦è‰æ¡ˆï¼š"
        echo "  - åŸ·è¡Œç‹€æ…‹: ${{ steps.draft_scraper.outcome }}"
        echo "  - æ–°å¢æ•¸é‡: ${{ steps.draft_scraper.outputs.new_draft_count }}"
        echo ""
        echo "æ•´é«”ç‹€æ…‹: ${{ job.status }}"
        echo "========================================"
