name: Integrated Tax Law Scraper

# éŒ¯èª¤é˜²è­·ï¼šæ˜ç¢ºå®šç¾©æ¬Šé™ï¼ˆé¿å… exit code 128ï¼‰
permissions:
  contents: write
  issues: write
  actions: read

on:
  schedule:
    # æ¯å¤©å°ç£æ™‚é–“ 18:00 åŸ·è¡Œ (UTC 10:00)
    - cron: '0 10 * * *'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  scrape_all:
    runs-on: ubuntu-latest
    
    steps:
    # Step 1: æª¢å‡ºç¨‹å¼ç¢¼
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²è¨˜éŒ„
    
    # Step 2: è¨­å®š Python ç’°å¢ƒ
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    # Step 3: å®‰è£ç›¸ä¾å¥—ä»¶
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 pandas lxml
        echo "âœ… å¥—ä»¶å®‰è£å®Œæˆ"
    
    # Step 4: åŸ·è¡Œç¨…å‹™å‡½é‡‹çˆ¬èŸ²
    - name: Run Tax Ruling Scraper
      id: tax_scraper
      continue-on-error: true  # å³ä½¿å¤±æ•—ä¹Ÿç¹¼çºŒåŸ·è¡Œ
      run: |
        echo "ğŸ” é–‹å§‹çˆ¬å–ç¨…å‹™å‡½é‡‹..."
        python smart_scraper.py
        echo "ğŸ“Š ç¨…å‹™å‡½é‡‹çˆ¬èŸ²åŸ·è¡Œå®Œæˆ"
    
    # Step 5: åŸ·è¡Œæ³•è¦è‰æ¡ˆçˆ¬èŸ²
    - name: Run Draft Law Scraper
      id: draft_scraper
      continue-on-error: true  # å³ä½¿å¤±æ•—ä¹Ÿç¹¼çºŒåŸ·è¡Œ
      run: |
        echo "ğŸ“œ é–‹å§‹çˆ¬å–æ³•è¦è‰æ¡ˆ..."
        python draft_law_scraper.py
        echo "ğŸ“Š æ³•è¦è‰æ¡ˆçˆ¬èŸ²åŸ·è¡Œå®Œæˆ"
    
    # Step 6: å»ºç«‹æ•´åˆé€šçŸ¥
    - name: Create integrated notification
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          let body = `# ğŸ“‹ å°ç£ç¨…å‹™æ³•è¦è‡ªå‹•ç›£æ§å ±å‘Š\n\n`;
          body += `ğŸ• **ç›£æ§æ™‚é–“**: ${new Date().toLocaleString('zh-TW', {timeZone: 'Asia/Taipei'})}\n\n`;
          
          // ç¨…å‹™å‡½é‡‹éƒ¨åˆ†
          const hasTax = '${{ steps.tax_scraper.outputs.has_new_tax }}' === 'true';
          const taxCount = '${{ steps.tax_scraper.outputs.new_tax_count }}';
          
          if (hasTax) {
            body += `## ğŸ“„ ç¨…å‹™å‡½é‡‹æ›´æ–°\n\n`;
            body += `ç™¼ç¾ **${taxCount}** ç­†æ–°å‡½é‡‹\n\n`;
            
            try {
              const taxFiles = fs.readdirSync('data').filter(f => f.startsWith('today_new'));
              if (taxFiles.length > 0) {
                const latestTax = taxFiles.sort().pop();
                const taxData = JSON.parse(fs.readFileSync(`data/${latestTax}`, 'utf8'));
                
                taxData.slice(0, 5).forEach((item, i) => {
                  body += `${i + 1}. **${item.title}**\n`;
                  body += `   - æ—¥æœŸ: ${item.date}\n`;
                  body += `   - å­—è™Ÿ: ${item.number}\n`;
                  if (item.url) {
                    body += `   - ğŸ”— [æŸ¥çœ‹åŸæ–‡](${item.url})\n`;
                  }
                  body += `\n`;
                });
                
                if (taxData.length > 5) {
                  body += `\n*é‚„æœ‰ ${taxData.length - 5} ç­†å‡½é‡‹ï¼Œè«‹æŸ¥çœ‹å®Œæ•´å ±å‘Šæª”æ¡ˆ*\n\n`;
                }
              }
            } catch (error) {
              console.log('è®€å–ç¨…å‹™å‡½é‡‹è³‡æ–™æ™‚å‡ºéŒ¯:', error);
              body += `ç„¡æ³•è®€å–è©³ç´°è³‡æ–™ï¼Œè«‹æŸ¥çœ‹ artifacts ä¸­çš„æª”æ¡ˆ\n\n`;
            }
          } else {
            body += `## ğŸ“„ ç¨…å‹™å‡½é‡‹æ›´æ–°\n\nâœ¨ æ²’æœ‰æ–°çš„ç¨…å‹™å‡½é‡‹\n\n`;
          }
          
          // æ³•è¦è‰æ¡ˆéƒ¨åˆ† - æ”¹é€²ç‰ˆURLé¡¯ç¤º
          const hasDraft = '${{ steps.draft_scraper.outputs.has_new_draft }}' === 'true';
          const draftCount = '${{ steps.draft_scraper.outputs.new_draft_count }}';
          
          if (hasDraft) {
            body += `## ğŸ“œ æ³•è¦è‰æ¡ˆæ›´æ–°\n\n`;
            body += `ç™¼ç¾ **${draftCount}** ç­†æ–°è‰æ¡ˆ\n\n`;
            
            try {
              const draftFiles = fs.readdirSync('data').filter(f => f.startsWith('drafts_'));
              if (draftFiles.length > 0) {
                const latestDraft = draftFiles.sort().pop();
                const draftData = JSON.parse(fs.readFileSync(`data/${latestDraft}`, 'utf8'));
                
                draftData.slice(0, 5).forEach((item, i) => {
                  body += `${i + 1}. **${item.title}**\n`;
                  body += `   - å…¬å‘Šæ—¥æœŸ: ${item.date}\n`;
                  body += `   - æˆªæ­¢æ—¥æœŸ: ${item.deadline}\n`;
                  body += `   - ç‹€æ…‹: ${item.status}\n`;
                  
                  // æ™ºèƒ½URLé¡¯ç¤º
                  if (item.url) {
                    if (item.url_type === 'original') {
                      body += `   - ğŸ”— [æŸ¥çœ‹åŸæ–‡](${item.url})\n`;
                    } else if (item.url_type === 'search') {
                      body += `   - ğŸ” [æœå°‹æ­¤è‰æ¡ˆ](${item.url})\n`;
                    } else {
                      body += `   - ğŸ”— [ç›¸é—œé€£çµ](${item.url})\n`;
                    }
                  }
                  
                  // æ·»åŠ å‚™ç”¨é€£çµ
                  if (item.backup_urls) {
                    if (item.backup_urls.site) {
                      body += `   - ğŸ“Œ [æ³•è¦é å‘Šç¶²ç«™](${item.backup_urls.site})\n`;
                    }
                    if (item.backup_urls.join_search && item.url_type !== 'original') {
                      body += `   - ğŸ›ï¸ [å…¬å…±æ”¿ç­–å¹³å°æœå°‹](${item.backup_urls.join_search})\n`;
                    }
                  }
                  
                  body += `\n`;
                });
                
                if (draftData.length > 5) {
                  body += `\n*é‚„æœ‰ ${draftData.length - 5} ç­†è‰æ¡ˆï¼Œè«‹æŸ¥çœ‹å®Œæ•´å ±å‘Šæª”æ¡ˆ*\n\n`;
                }
                
                // æ·»åŠ ä½¿ç”¨æç¤º
                body += `### ğŸ’¡ ä½¿ç”¨æç¤º\n`;
                body += `- ğŸ”— **æŸ¥çœ‹åŸæ–‡**: ç›´æ¥é€£çµåˆ°è‰æ¡ˆé é¢\n`;
                body += `- ğŸ” **æœå°‹æ­¤è‰æ¡ˆ**: Googleæœå°‹è©²è‰æ¡ˆç›¸é—œè³‡è¨Š\n`;
                body += `- ğŸ“Œ **æ³•è¦é å‘Šç¶²ç«™**: è²¡æ”¿éƒ¨æ³•è¦é å‘Šä¸»é é¢\n`;
                body += `- ğŸ›ï¸ **å…¬å…±æ”¿ç­–å¹³å°**: æ”¿åºœæ”¿ç­–åƒèˆ‡å¹³å°æœå°‹\n\n`;
                
              }
            } catch (error) {
              console.log('è®€å–æ³•è¦è‰æ¡ˆè³‡æ–™æ™‚å‡ºéŒ¯:', error);
              body += `ç„¡æ³•è®€å–è©³ç´°è³‡æ–™ï¼Œè«‹æŸ¥çœ‹ artifacts ä¸­çš„æª”æ¡ˆ\n\n`;
            }
          } else {
            body += `## ğŸ“œ æ³•è¦è‰æ¡ˆæ›´æ–°\n\nâœ¨ æ²’æœ‰æ–°çš„æ³•è¦è‰æ¡ˆ\n\n`;
          }
          
          // åŸ·è¡Œç‹€æ…‹æ‘˜è¦
          body += `## ğŸ” åŸ·è¡Œç‹€æ…‹\n\n`;
          body += `- ç¨…å‹™å‡½é‡‹çˆ¬èŸ²: ${{ steps.tax_scraper.outcome }}\n`;
          body += `- æ³•è¦è‰æ¡ˆçˆ¬èŸ²: ${{ steps.draft_scraper.outcome }}\n\n`;
          
          // è³‡æ–™æª”æ¡ˆèªªæ˜
          body += `## ğŸ“ è³‡æ–™æª”æ¡ˆ\n\n`;
          body += `å®Œæ•´çš„ç›£æ§è³‡æ–™å·²ä¸Šå‚³è‡³ Artifactsï¼ŒåŒ…å«ï¼š\n`;
          body += `- JSON æ ¼å¼çš„åŸå§‹è³‡æ–™\n`;
          body += `- CSV æ ¼å¼çš„è¡¨æ ¼è³‡æ–™\n`;
          body += `- æ­·å²è¨˜éŒ„å’Œæ¯”å°çµæœ\n\n`;
          
          body += `---\n`;
          body += `*æ­¤å ±å‘Šç”±è‡ªå‹•åŒ–ç³»çµ±ç”Ÿæˆ*`;
          
          // åªåœ¨æœ‰æ–°è³‡æ–™æ™‚å»ºç«‹ Issue
          const shouldCreateIssue = hasTax || hasDraft;
          
          if (shouldCreateIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ç¨…å‹™æ³•è¦ç›£æ§å ±å‘Š - ${new Date().toLocaleDateString('zh-TW')}`,
              body: body,
              labels: ['auto-update', 'tax-law']
            });
            
            console.log('âœ… é€šçŸ¥å·²å»ºç«‹');
          } else {
            console.log('ğŸ“ ç„¡æ–°è³‡æ–™ï¼Œè·³éé€šçŸ¥å»ºç«‹');
          }
    
    # Step 7: ä¸Šå‚³è³‡æ–™æª”æ¡ˆ
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: scraping-results-${{ github.run_number }}
        path: |
          data/*.json
          data/*.csv
        retention-days: 30
    
    # Step 8: æäº¤æ­·å²è¨˜éŒ„åˆ° repository
    - name: Commit history files
      if: always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # åªæäº¤æ­·å²æª”æ¡ˆï¼Œé¿å…é‡è¤‡æäº¤å¤§é‡è³‡æ–™
        git add data/*history.json data/*report.json 2>/dev/null || true
        
        if git diff --staged --quiet; then
          echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
        else
          git commit -m "Update scraping history - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… æ­·å²è¨˜éŒ„å·²æ›´æ–°"
        fi
    
    # Step 9: åŸ·è¡Œæ‘˜è¦
    - name: Show execution summary
      if: always()
      run: |
        echo "========================================"
        echo "ğŸ“Š åŸ·è¡Œæ‘˜è¦"
        echo "========================================"
        echo "ç¨…å‹™å‡½é‡‹ï¼š"
        echo "  - åŸ·è¡Œç‹€æ…‹: ${{ steps.tax_scraper.outcome }}"
        echo "  - æ–°å¢æ•¸é‡: ${{ steps.tax_scraper.outputs.new_tax_count }}"
        echo ""
        echo "æ³•è¦è‰æ¡ˆï¼š"
        echo "  - åŸ·è¡Œç‹€æ…‹: ${{ steps.draft_scraper.outcome }}"
        echo "  - æ–°å¢æ•¸é‡: ${{ steps.draft_scraper.outputs.new_draft_count }}"
        echo ""
        echo "æ•´é«”ç‹€æ…‹: ${{ job.status }}"
        echo "========================================"
