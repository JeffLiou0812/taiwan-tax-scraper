name: Smart Scraper

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:

# ğŸ”‘ æ¬Šé™è¨­å®š
permissions:
  contents: write          # å…è¨±è®€å¯«æª”æ¡ˆå’Œè³‡æ–™å¤¾
  actions: read           # å…è¨±è®€å– GitHub Actions
  pages: write            # å…è¨±å¯«å…¥ GitHub Pagesï¼ˆå¯é¸ï¼‰
  id-token: write         # å…è¨± OIDC token é©—è­‰
  security-events: write  # å…è¨±å®‰å…¨äº‹ä»¶å¯«å…¥ï¼ˆå¯é¸ï¼‰
  issues: write           # å…è¨±å»ºç«‹ Issuesï¼ˆç”¨æ–¼é€šçŸ¥ï¼‰

jobs:
  smart-scrape:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æª¢å‡ºç¨‹å¼ç¢¼
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. è¨­å®šPythonç’°å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # 3. å®‰è£å¿…è¦å¥—ä»¶
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 pandas lxml
          echo "âœ… å¥—ä»¶å®‰è£å®Œæˆ"
      
      # 4. åŸ·è¡Œæ™ºæ…§çˆ¬èŸ²
      - name: Run smart scraper
        id: scrape
        run: |
          echo "ğŸ¤– åŸ·è¡Œæ™ºæ…§çˆ¬èŸ²..."
          python smart_scraper.py
          echo "âœ… çˆ¬èŸ²åŸ·è¡Œå®Œæˆ"
      
      # 5. è®€å–åŸ·è¡Œå ±å‘Š
      - name: Read report
        id: report
        run: |
          if [ -f data/daily_report.json ]; then
            has_new=$(python -c "import json; r=json.load(open('data/daily_report.json')); print('true' if r.get('has_new') else 'false')")
            new_count=$(python -c "import json; r=json.load(open('data/daily_report.json')); print(r.get('new_count', 0))")
            echo "has_new=$has_new" >> $GITHUB_OUTPUT
            echo "new_count=$new_count" >> $GITHUB_OUTPUT
            echo "ğŸ“Š å ±å‘Š: æ–°å‡½é‡‹=$new_count"
          else
            echo "has_new=false" >> $GITHUB_OUTPUT
            echo "new_count=0" >> $GITHUB_OUTPUT
          fi
      
      # 6. å»ºç«‹é€šçŸ¥Issueï¼ˆåªåœ¨æœ‰æ–°å‡½é‡‹æ™‚ï¼‰
      - name: Create notification
        if: steps.report.outputs.has_new == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // è®€å–æ–°å‡½é‡‹è³‡æ–™
            let newRulings = [];
            let report = {};
            
            try {
              newRulings = JSON.parse(fs.readFileSync('data/today_new.json', 'utf8'));
              report = JSON.parse(fs.readFileSync('data/daily_report.json', 'utf8'));
            } catch (e) {
              console.log('Error reading files:', e);
              return;
            }
            
            // å»ºç«‹Issueå…§å®¹
            let body = `# ğŸ“¢ ç¨…å‹™å‡½é‡‹æ›´æ–°é€šçŸ¥\n\n`;
            body += `> ğŸ• åŸ·è¡Œæ™‚é–“: ${report.execution_time}\n\n`;
            body += `## ğŸ“Š çµ±è¨ˆ\n`;
            body += `- æª¢æŸ¥å‡½é‡‹: ${report.total_checked} ç­†\n`;
            body += `- **æ–°å¢å‡½é‡‹: ${report.new_count} ç­†** âœ¨\n\n`;
            
            if (newRulings.length > 0) {
              body += `## ğŸ“‹ æ–°å‡½é‡‹æ¸…å–®\n\n`;
              
              newRulings.forEach((ruling, idx) => {
                body += `### ${idx + 1}. ${ruling.title || '(ç„¡æ¨™é¡Œ)'}\n`;
                if (ruling.date) body += `- ğŸ“… æ—¥æœŸ: ${ruling.date}\n`;
                if (ruling.number) body += `- ğŸ“ å­—è™Ÿ: ${ruling.number}\n`;
                if (ruling.url) body += `- ğŸ”— [æŸ¥çœ‹åŸæ–‡](${ruling.url})\n`;
                body += `\n---\n\n`;
              });
            }
            
            body += `\nğŸ’¾ [ä¸‹è¼‰å®Œæ•´è³‡æ–™](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`;
            
            // å»ºç«‹Issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ†• ç™¼ç¾ ${report.new_count} ç­†æ–°ç¨…å‹™å‡½é‡‹ - ${new Date().toLocaleDateString('zh-TW')}`,
              body: body,
              labels: ['smart-notification', 'new-rulings']
            });
            
            console.log('âœ… é€šçŸ¥å·²å»ºç«‹');
      
      # 7. ä¸Šå‚³æ‰€æœ‰çµæœ
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smart-results-${{ github.run_number }}
          path: data/
          retention-days: 30
      
      # 8. æäº¤æ­·å²è¨˜éŒ„ï¼ˆä¿æŒè¿½è¹¤ï¼‰
      - name: Commit history
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Smart Scraper Bot"
          
          # åªæäº¤æ­·å²æª”æ¡ˆï¼Œä¸æäº¤æ¯æ—¥è³‡æ–™
          if [ -f data/smart_history.json ]; then
            git add data/smart_history.json
            git diff --quiet && git diff --staged --quiet || (
              git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°: å‡½é‡‹æ­·å²è¨˜éŒ„ $(date +'%Y-%m-%d %H:%M')"
              git push
            )
          fi
      
      # 9. é¡¯ç¤ºåŸ·è¡Œæ‘˜è¦
      - name: Show summary
        if: always()
        run: |
          echo "======================================"
          echo "ğŸ æ™ºæ…§çˆ¬èŸ²åŸ·è¡Œå®Œæˆ"
          echo "======================================"
          if [ "${{ steps.report.outputs.has_new }}" == "true" ]; then
            echo "ğŸ¯ ç™¼ç¾æ–°å‡½é‡‹: ${{ steps.report.outputs.new_count }} ç­†"
            echo "ğŸ“§ å·²å»ºç«‹é€šçŸ¥"
          else
            echo "âœ¨ ä»Šå¤©æ²’æœ‰æ–°å‡½é‡‹"
          fi
          echo "======================================"
